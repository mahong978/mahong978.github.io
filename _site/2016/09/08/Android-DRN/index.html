<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Android N新特性：direct reply notification</title>
    <meta name="description" content="Android N带来了一系列新功能，比如分屏与画中画，更好的后台管理等，其中就包括了direct reply notification，顾名思义，就是可以直接回复的通知。">

    <link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="stylesheet" href=" /css/fontawesome/css/font-awesome.min.css ">
    <link rel="stylesheet" href=" /css/main.css ">
    <!--<link rel="stylesheet" href=" /css/syntax.css ">-->
    <link rel="canonical" href="http://mahong978.github.io/2016/09/08/Android-DRN/">
    <link rel="alternate" type="application/rss+xml" title="Mahong" href="http://mahong978.github.io /feed.xml ">


    <script>
    // 百度统计代码
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?c4e3e6dfb970411c574e62c2c06e0c41";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>


    <script>
    // google analytics
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-72449510-4', 'auto');
      ga('send', 'pageview');

    </script>

</head>


  <body>

    <header id="top">
    <div class="wrapper">
        <a href="/" class="brand">Mahong</a>
        <small>Android Developer</small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/">
                    
                        <i class="fa fa-home"></i>主页
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>存档
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>分类
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tag/">
                        
                            <i class="fa fa-tags"></i>标签
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/collection/">
                        
                            <i class="fa fa-bookmark"></i>Collections
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/demo/">
                        
                            <i class="fa fa-play"></i>Demo
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/about/">
                        
                            <i class="fa fa-heart"></i>About
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" post>
    <div class="left">
        <h1>Android N新特性：direct reply notification</h1>
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2016-09-08
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#Android" title="Category: Android" rel="category">Android</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

            <div class="label-card">
            
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <!--a href="/tag/#Android" title="Tag: Android" rel="tag">Android</a-->
        <a href="/tag/#Android" title="Tag: Android" rel="tag">Android</a>&nbsp;
    
        <!--a href="/tag/#Notification" title="Tag: Notification" rel="tag">Notification</a-->
        <a href="/tag/#Notification" title="Tag: Notification" rel="tag">Notification</a>
    
  

</span>

            </div>

        </div>
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <ul id="markdown-toc">
  <li><a href="#section" id="markdown-toc-section">主要流程</a></li>
  <li><a href="#notification" id="markdown-toc-notification">构建Notification</a>    <ul>
      <li><a href="#remoteinput" id="markdown-toc-remoteinput">RemoteInput</a></li>
      <li><a href="#notificationcompataction" id="markdown-toc-notificationcompataction">NotificationCompat.Action</a>        <ul>
          <li><a href="#pendingintent" id="markdown-toc-pendingintent">PendingIntent</a></li>
        </ul>
      </li>
      <li><a href="#notificationcompatbuilder" id="markdown-toc-notificationcompatbuilder">NotificationCompat.Builder</a></li>
    </ul>
  </li>
  <li><a href="#section-1" id="markdown-toc-section-1">处理回复</a></li>
  <li><a href="#section-2" id="markdown-toc-section-2">更新通知</a></li>
</ul>

<p>Android N带来了一系列新功能，比如分屏与画中画，更好的后台管理等，其中就包括了direct reply notification，顾名思义，就是可以直接回复的通知。</p>

<p>试想一下，在以往的Android系统中，你正在使用的一款社交应用不在前台时，当有新消息时往往是以通知的方法进行提醒的，这时你从状态栏下滑，显示出通知列表，然后点击那个通知进入应用的聊天界面，最后才进行回复。这中间包括了多个手势和界面跳转，当应用优化或者手机性能较差时，这将会花上相当的时间，所带来的用户体验将会是比较差的。</p>

<p>Android N带来的直接回复通知的功能，允许用户直接在通知控件上进行回复，这就免去了上面所述的步骤，优化了用户体验。下面就让我们对direct reply notification进行研究</p>

<hr />

<h2 id="section">主要流程</h2>

<p>在开始之前，先来理清一下中间的步骤：</p>

<ol>
  <li>接收消息一般是使用Service在后台运行</li>
  <li>当有新消息时，Service发出Notification</li>
  <li>用户在通知上回复后，需要进行发送，由于通知的响应是通过PendingIntent进行的，所以这里使用IntentService来负责发送是最好的</li>
  <li>IntentService发送完后，发送广播，Service监听相关广播，收到广播后进行通知的更新</li>
</ol>

<p>主要流程大概就是这样，下面就开始一步步地来进行探索</p>

<hr />

<h2 id="notification">构建Notification</h2>

<p>监听消息的Service在接收一条新消息后，将发出一条通知，那么直接回复的通知是如何构建的呢？</p>

<p>这里要先了解一下RemoteInput。RemoteInput原先是在Android Wearable的API中使用的，通过Notification.Builder的setRemoteInput方法设置，可以让用户在手表的通知上进行语音回复。现在RemoteInput也能进行文字输入了，它将在这里发挥重要作用。</p>

<p>我们知道，Android L开始，通知可以通过添加action，在通知控件上添加额外的交互控件来提供额外的操作，这里也一样，RemoteInput是通过Notification.Action加入到Notification中的</p>

<h3 id="remoteinput">RemoteInput</h3>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">RemoteInput</span> <span class="n">remoteInput</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RemoteInput</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">KEY_REPLY</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setLabel</span><span class="o">(</span><span class="n">label</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre>
</div>

<p>RemoteInput使用了建造者模式，RemoteInput.Builder的构造函数中需要提供一个String类型的resultKey，这个key将会在后面提取用户输入内内容的时候用到。setLabel()方法是设置用户点开输入框后的hint文字</p>

<hr />

<h3 id="notificationcompataction">NotificationCompat.Action</h3>

<p>由于RemoteInput是v4 support包的，因此这里的通知是使用v4 support的NotificationCompat进行构建的</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">NotificationCompat</span><span class="o">.</span><span class="na">Action</span> <span class="n">action</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NotificationCompat</span><span class="o">.</span><span class="na">Action</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span>
                <span class="n">R</span><span class="o">.</span><span class="na">mipmap</span><span class="o">.</span><span class="na">ic_launcher</span><span class="o">,</span>
                <span class="n">label</span><span class="o">,</span>
                <span class="n">pendingIntent</span>
        <span class="o">)</span>
        <span class="o">.</span><span class="na">addRemoteInput</span><span class="o">(</span><span class="n">remoteInput</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre>
</div>

<p>Builder构造器的三个参数分别是该action对应的icon资源（在这里好像没什么用），action的标题，对应的PendingIntent（用于启动处理消息回复）。
Builder调用addRemoteInput()方法设置RemoteInput</p>

<h4 id="pendingintent">PendingIntent</h4>

<p>我们这里的PendingIntent是用来启动负责消息回复的成员，它可以是：</p>

<ul>
  <li>Service或者BroadcastReceiver
 它们没有UI，适合后台操作，因此是直接回复通知的最佳选择</li>
  <li>Activity
 具有UI ，会关闭通知栏，会要求用户解锁设备</li>
</ul>

<p>因此对于Android N以下的系统，由于SDK不直接支持RemoteInput，而且你需要让用户知道程序有没有在进行回复，应该启动Activity。对于Android N或以上的系统，应该启动Service或BroadcastReceiver</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">Intent</span> <span class="n">sendIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">SendService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">PendingIntent</span> <span class="n">pendingIntent</span> <span class="o">=</span> <span class="n">PendingIntent</span><span class="o">.</span><span class="na">getService</span><span class="o">(</span>
        <span class="k">this</span><span class="o">,</span>
        <span class="n">CODE_NEW_MESSAGE</span><span class="o">,</span>
        <span class="n">sendIntent</span><span class="o">,</span>
        <span class="n">PendingIntent</span><span class="o">.</span><span class="na">FLAG_ONE_SHOT</span>
<span class="o">);</span>
</code></pre>
</div>

<hr />

<h3 id="notificationcompatbuilder">NotificationCompat.Builder</h3>

<p>Notification.Builder的使用以及通知的发送就不用介绍了：</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NotificationCompat</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setSmallIcon</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">mipmap</span><span class="o">.</span><span class="na">ic_launcher</span><span class="o">)</span>
        <span class="o">.</span><span class="na">addAction</span><span class="o">(</span><span class="n">action</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setStyle</span><span class="o">(</span><span class="n">style</span><span class="o">);</span>
<span class="n">NotificationManager</span> <span class="n">manager</span> <span class="o">=</span> <span class="o">(</span><span class="n">NotificationManager</span><span class="o">)</span> <span class="n">getSystemService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">NOTIFICATION_SERVICE</span><span class="o">);</span>
<span class="n">manager</span><span class="o">.</span><span class="na">notify</span><span class="o">(</span><span class="n">ID_NEW_MESSAGE</span><span class="o">,</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
</code></pre>
</div>

<p>Notification.Builder的setStyle方法可以给通知添加样式，API预置的样式有：</p>

<ul>
  <li>Notification.BigPictureStyle</li>
  <li>Notification.BigTextStyle</li>
  <li>Notification.DecoratedCustomViewStyle</li>
  <li>Notification.InboxStyle</li>
  <li>Notification.MediaStyle</li>
  <li>Notification.MessagingStyle</li>
</ul>

<p>其中MessagingStyle很适合在这种情境下使用</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">style</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NotificationCompat</span><span class="o">.</span><span class="na">MessagingStyle</span><span class="o">(</span><span class="s">"我"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setConversationTitle</span><span class="o">(</span><span class="s">"吃货日常"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">addMessage</span><span class="o">(</span><span class="s">"今晚吃点啥"</span><span class="o">,</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">(),</span> <span class="s">"mahong"</span><span class="o">);</span>
</code></pre>
</div>

<p>其中构造器的参数是用户的显示名，setConversationTitle()是设置此次对话的标题，addMessage()是添加一条消息，参数分别是消息内容，时间戳以及对方的用户名（如果是用户自己发出的则设为null）</p>

<hr />

<h2 id="section-1">处理回复</h2>

<p>当用户进行了回复后，回复内容会被包装在一个Intent中，发送到action的PendingIntent指向的Service，BroadcastReceiver或Activity</p>

<p>取出Intent内容的方法不是通常的getExtra()，而是通过RemoteInput.getResultFromIntent()取出的</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onHandleIntent</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Bundle</span> <span class="n">bundle</span> <span class="o">=</span> <span class="n">RemoteInput</span><span class="o">.</span><span class="na">getResultsFromIntent</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">bundle</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">CharSequence</span> <span class="n">replyText</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="na">getCharSequence</span><span class="o">(</span><span class="n">ReceiveService</span><span class="o">.</span><span class="na">KEY_REPLY</span><span class="o">);</span>

        <span class="n">Intent</span> <span class="n">replyIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">();</span>
        <span class="n">replyIntent</span><span class="o">.</span><span class="na">setAction</span><span class="o">(</span><span class="s">"com.example.mahong.test.SEND_OVER"</span><span class="o">);</span>
        <span class="n">replyIntent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="n">ReceiveService</span><span class="o">.</span><span class="na">KEY_REPLY</span><span class="o">,</span> <span class="n">replyText</span><span class="o">);</span>
        <span class="n">sendBroadcast</span><span class="o">(</span><span class="n">replyIntent</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>这里省略去了发送回复的逻辑</p>

<p>需要注意的是，从Bundle中取出文本时使用的键，是创建RemoteInput对象时指定的键</p>

<hr />

<h2 id="section-2">更新通知</h2>

<p>用户点击发送按钮回复后，发送按钮会变成一个progress小圆圈，如果你在上面那步就结束的话，这个progress小圆圈就会一直转个不停，这样的用户体验显然是不好的，因此需要在消息发送成功后更新通知</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceive</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">CharSequence</span> <span class="n">sequence</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getCharSequenceExtra</span><span class="o">(</span><span class="n">KEY_REPLY</span><span class="o">);</span>
    <span class="n">style</span><span class="o">.</span><span class="na">addMessage</span><span class="o">(</span><span class="n">sequence</span><span class="o">,</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">(),</span> <span class="kc">null</span><span class="o">);</span>

    <span class="n">NotificationManager</span> <span class="n">manager</span> <span class="o">=</span> <span class="o">(</span><span class="n">NotificationManager</span><span class="o">)</span> <span class="n">getSystemService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">NOTIFICATION_SERVICE</span><span class="o">);</span>
    <span class="n">manager</span><span class="o">.</span><span class="na">notify</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
<span class="o">}</span>
</code></pre>
</div>

<p>如果是使用MessagingStyle的话，用addMessage()加上用户的回复，然后重新build()一下，用相同的id再发一次通知就行了</p>

<p>对于其他的style，则需要使用setRemoteInputHistory()来添加回复</p>

<hr />

<p>整个流程大概就是这样，让我们来看看效果：</p>

<p><img src="http://od654njdm.bkt.clouddn.com/test.gif" alt="" /></p>


        </article>
        <hr>

        
        
            
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
        
        

        <div class="post-recent">
    <div class="pre">
        
        <p><strong>上一篇</strong> <a href="/2016/09/07/Java-holding-objects/">Java笔记整理：持有对象</a></p>
        
    </div>
    <div class="nex">

        
    </div>
</div>


        <h2 id="comments">Comments</h2>
        
<!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="http://mahong978.github.io/2016/09/08/Android-DRN/" data-title="Android N新特性：direct reply notification" data-url="http://mahong978.github.io/2016/09/08/Android-DRN/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    var duoshuoQuery = {
        short_name: "mahong978"
    };
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';
        ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
</script>
<!-- 多说公共JS代码 end -->






    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    Content
                </div>
                <ul id="content-side" class="content-ul">
                    <li><a href="#similar_posts">Similar Posts</a></li>
                    <li><a href="#comments">Comments</a></li>
                </ul>
            </div>
            <!-- 其他div框放到这里 -->
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>


    <footer class="site-footer">


    <div class="wrapper">

        <p class="description">
             个人博客 
        </p>
        <p class="contact">
            Contact me at: 
            <a href="https://github.com/mahong978" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a>  
            <a href="mailto:1350374964@qq.com" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>  
            <a href="http://weibo.com/mahq" title="Weibo"><i class="fa fa-weibo" aria-hidden="true"></i></a>  
            <a href="https://www.zhihu.com/people/ma-hong-66" title="Zhihu"><i class="iconfont">&#xe829;</i></a>   
            <a href="https://www.facebook.com/mahong978" title="Facebook"><i class="fa fa-facebook-official" aria-hidden="true"></i></a>    
        </p>
        <p>
            本站总访问量<span id="busuanzi_value_site_pv"></span>次，本站访客数<span id="busuanzi_value_site_uv"></span>人次，本文总阅读量<span id="busuanzi_value_page_pv"></span>次
        </p>
        <p class="power">
            <span>
                Site powered by <a href="https://jekyllrb.com/">Jekyll</a> & <a href="https://pages.github.com/">Github Pages</a>.
            </span>
            <span>
                Theme designed by <a href="https://github.com/Gaohaoyang">HyG</a>.
            </span>
        </p>
    </div>
</footer>
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <div class="back-to-top">
    <a href="#top" class="scroll">
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/scroll.min.js " charset="utf-8"></script>
  </body>

</html>
